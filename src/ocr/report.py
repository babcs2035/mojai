"""
ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼

OCR ã®èªè­˜çµæœï¼ŒæŠ½å‡ºã•ã‚ŒãŸæ–‡å­—ç”»åƒï¼ŒãŠã‚ˆã³ç®—å‡ºã•ã‚ŒãŸç¢ºä¿¡åº¦ã‚’ã¾ã¨ã‚ï¼Œ
ãƒ–ãƒ©ã‚¦ã‚¶ã§é–²è¦§å¯èƒ½ãª HTML ãƒ¬ãƒãƒ¼ãƒˆã‚’å‹•çš„ã«æ§‹ç¯‰ã™ã‚‹ï¼
"""

from pathlib import Path


class ReportGenerator:
    """
    HTML ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¯ãƒ©ã‚¹ï¼

    è§£æçµæœã® JSON ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šï¼ŒCSS ã§è£…é£¾ã•ã‚ŒãŸè¦–è¦šçš„ãªãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã™ã‚‹ï¼
    """

    def __init__(self, output_dir: Path):
        """
        ãƒ¬ãƒãƒ¼ãƒˆã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–ã™ã‚‹ï¼

        Args:
            output_dir (Path): ãƒ¬ãƒãƒ¼ãƒˆãŠã‚ˆã³é–¢é€£ã‚¢ã‚»ãƒƒãƒˆãŒä¿å­˜ã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼
        """
        self.output_dir = output_dir

    def generate(self, data: dict) -> Path:
        """
        è§£ææƒ…å ±ã‚’å…ƒã« HTML ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼

        Args:
            data (dict): è§£æçµæœã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³å„æ–‡å­—ã®æƒ…å ±ã®è¾æ›¸ï¼

        Returns:
            Path: ç”Ÿæˆã•ã‚ŒãŸ report.html ã®çµ¶å¯¾ãƒ‘ã‚¹ï¼
        """
        # HTML éª¨æ ¼ãŠã‚ˆã³ã‚¹ã‚¿ã‚¤ãƒ«ã®å®šç¾©
        html_parts = [
            "<!DOCTYPE html>",
            "<html lang='ja'>",
            "<head>",
            "  <meta charset='UTF-8'>",
            "  <meta name='viewport' content='width=device-width, initial-scale=1.0'>",
            "  <title>mojai OCR Analysis Report</title>",
            "  <style>",
            "    /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚«ãƒ©ãƒ¼ã«åŸºã¥ã„ãŸãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒã‚’æ¡ç”¨ */",
            "    * { box-sizing: border-box; margin: 0; padding: 0; }",
            "    body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #1a1a2e; color: #eee; padding: 20px; }",
            "    h1 { text-align: center; margin-bottom: 20px; color: #00d4ff; }",
            "    .meta { background: #16213e; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #1f4068; }",
            "    .meta p { margin: 5px 0; }",
            "    .chars { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }",
            "    /* å„æ–‡å­—ã‚’ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤º */",
            "    .char { background: #0f3460; border-radius: 8px; padding: 10px; text-align: center; min-width: 65px; border: 1px solid #16213e; }",
            "    .char img { max-height: 50px; border: 1px solid #333; background: #fff; display: block; margin: 0 auto; border-radius: 4px; }",
            "    .char-label { margin-top: 5px; font-size: 18px; color: #00d4ff; font-weight: bold; }",
            "    .char-index { font-size: 10px; color: #888; margin-top: 2px; }",
            "    .char-conf { font-weight: bold; }",
            "    .summary { text-align: center; margin-top: 20px; color: #888; font-size: 12px; }",
            "  </style>",
            "</head>",
            "<body>",
            "  <h1>ğŸ“ mojai OCR Analysis Report</h1>",
            "  <div class='meta'>",
            f"    <p><strong>Source File:</strong> {data['source_path']}</p>",
            f"    <p><strong>Total Characters:</strong> {data['metadata']['total_characters']}</p>",
            f"    <p><strong>OCR Engine:</strong> {data['metadata'].get('detector', 'N/A')}</p>",
            f"    <p><strong>Total Accuracy:</strong> {data['metadata'].get('accuracy', 0.0):.1%}</p>",
            "  </div>",
            "  <div class='chars'>",
        ]

        # å„æ–‡å­—ã®ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
        for char in data.get("characters", []):
            img_path = char.get("image_path", "")
            confidence = char.get("confidence", 0.0)

            # ç¢ºä¿¡åº¦ã«åŸºã¥ã„ãŸè¦–è¦šçš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆä¿¡å·æ©Ÿè‰²ï¼‰
            # 90% ä»¥ä¸Šã¯å®‰å…¨ï¼Œ80% æœªæº€ã¯ç¢ºèªæ¨å¥¨ã¨ã—ã¦è‰²åˆ†ã‘ã™ã‚‹
            if confidence >= 0.9:
                conf_color = "#4caf50"  # ç·‘ï¼ˆé«˜ä¿¡é ¼ï¼‰
            elif confidence >= 0.8:
                conf_color = "#ffeb3b"  # é»„ï¼ˆä¸­ä¿¡é ¼ï¼‰
            else:
                conf_color = "#f44336"  # èµ¤ï¼ˆä½ä¿¡é ¼ï¼‰

            conf_percent = f"{confidence:.1%}"

            html_parts.append("    <div class='char'>")
            # æŠ½å‡ºã•ã‚ŒãŸæ–‡å­—ç”»åƒã®åŸ‹ã‚è¾¼ã¿
            if img_path:
                html_parts.append(f"      <img src='{img_path}' alt='{char['text']}'>")

            # èªè­˜çµæœï¼ˆã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã®è¡¨ç¤º
            html_parts.append(f"      <div class='char-label'>{char['text']}</div>")
            # èªè­˜ã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆé€šã—ç•ªå·ï¼‰
            html_parts.append(f"      <div class='char-index'>ID: {char['index']}</div>")
            # ç¢ºä¿¡åº¦ã®è¡¨ç¤º
            html_parts.append(
                f"      <div class='char-conf' style='color: {conf_color}; font-size: 12px; margin-top: 2px;'>{conf_percent}</div>"
            )
            html_parts.append("    </div>")

        # ãƒ•ãƒƒã‚¿ãƒ¼ã®è¿½åŠ 
        html_parts.extend(
            [
                "  </div>",
                "  <div class='summary'>Generated by mojai platform</div>",
                "</body>",
                "</html>",
            ]
        )

        # ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãå‡ºã—
        report_path = self.output_dir / "report.html"
        report_path.write_text("\n".join(html_parts), encoding="utf-8")

        return report_path
