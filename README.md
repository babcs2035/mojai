# mojai: 手書き文字デジタル化・復元プラットフォーム

mojai（モジャイ）は，日本語の手書き文書を高精度にデジタル化し，その書体（スタイル）を維持したままフォントとして復元するための次世代プラットフォームである．
高度な Transformer ベースの OCR 認識と，拡散モデルを用いたワンショットフォント生成技術を統合し，手書き文字の保存と再利用を実現する．

## 🚀 主要機能

### 1. 手書き文字認識 (OCR Pipeline)
`manga-ocr` をコアエンジンとして採用し，日本語手書き文字の特性に最適化された認識フローを提供する．
- **行単位認識**: Transformer ベースの VisionEncoderDecoder モデルにより，文脈を考慮した極めて高い認識精度を実現．
- **高度な文字分割**: 垂直投影プロファイル（Projection Profile）と谷点検出（Valley Detection）を組み合わせた幾何学的アルゴリズムにより，文字単位の切り出しを高精度に行なう．
- **信頼度スコアの可視化**: 文字ごとの認識信頼度（Confidence Score）を算出し，HTML レポート上で視覚的に確認可能．

### 2. 高速検証インターフェース (Verify UI)
CUI ベースの高速な検証フローを提供し，OCR 結果の効率的な確認と修正をサポートする．

### 3. フォント生成 (Generate Engine)
拡散モデルを用いたワンショットフォント生成技術により，わずかな手書き文字のスタイル参照画像から，その特徴を継承した TrueType フォント（TTF）を構築する．

## 🛠️ 技術詳細

### 文字分割アルゴリズム
本プラットフォームでは，OCR モデル（manga-ocr）が行単位の認識に特化していることを利用し，以下のステップで文字分割を行なう：
1. **行検出**: 二値化画像に対して水平投影解析を行ない，行の境界を特定する．
2. **行単位 OCR**: `manga-ocr` により，行全体の文字列を認識する．この際，生成トークンのロジットから信頼度を算出する．
3. **垂直投影解析**: 行画像に対して垂直投影プロファイルを計算し，ガウシアンフィルタで平滑化を行なう．
4. **谷点検出**: 平滑化された信号に対して `scipy.signal.find_peaks` を適用し，文字間の境界候補となる「谷」を特定する．
5. **文字数整合**: 認識された文字列の長さと谷点の位置を最適化アルゴリズムで調整し，各文字の境界座標を決定する．

### 信頼度算出ロジック
Transformers ライブリの `generate` メソッドを直接制御し，各生成トークンの Softmax 確率を抽出する．
デコードされた文字とトークンのアライメントを動的に調整することで，HTML レポート上での確信度表示を実現している．

## 📦 必要要件
- Python 3.11 以上
- **[mise](https://mise.jdx.dev/)**: タスクランナーおよび環境管理
- **[uv](https://github.com/astral-sh/uv)**: 高速な Python 依存関係管理
- NVIDIA GPU (RTX 3090 以上を推奨，VRAM 24GB)

## 🏗️ セットアップ
```bash
# プロジェクトの信頼設定
mise trust

# 依存関係のインストール
mise run setup

# 学習済みモデルのダウンロード
mise run download-models
```

## 📖 使用方法

### OCR 実行とレポート生成
```bash
# 特定の画像を処理
mise run ocr
```
※ 入力画像は `data/input/image.png`，アノテーションは `data/input/annotation.txt` に配置する．
処理完了後，`data/output/report.html` が自動的にブラウザで開かれる．

### フォント生成（開発中）
```bash
# スタイル参照画像からのフォント構築
mise run generate
```

## 🧪 開発と品質管理
```bash
# テストの実行
mise run test

# 静的解析とフォーマット
mise run lint
mise run format
```

## 📜 ライセンス
本プロジェクトは商用利用を制限した研究・実験目的のプロトタイプである．
詳細についてはプロジェクト管理者へ問い合わせること．
